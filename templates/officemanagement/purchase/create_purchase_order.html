{% extends "base.html" %}
{% load static %}
{% load custom_filters %}

{% block content %}
<div class="container-fluid mt-4">
  <div class="card shadow-lg border-0 rounded-4">
    <div class="card-header bg-primary text-white rounded-top-4 d-flex justify-content-between align-items-center">
      <h4 class="mb-0"><i class="fas fa-shopping-cart me-2"></i>Create Stationary Purchase Order</h4>
      <a href="{% url 'officemanagement:purchase_request_list' %}" class="btn btn-light btn-sm">
        <i class="fas fa-arrow-left"></i> Back to List
      </a>
    </div>

    <div class="card-body bg-light">
      <form method="POST" enctype="multipart/form-data" novalidate>
        {% csrf_token %}
        <div class="row mb-3">
          <div class="col-md-4">
            <label class="form-label fw-semibold">Supplier</label>
            {{ order_form.supplier|add_class:"form-select" }}
          </div>
          <div class="col-md-4">
            <label class="form-label fw-semibold">Order Date</label>
            {{ order_form.order_date|add_class:"form-control" }}
          </div>
        </div>

        <fieldset class="border rounded-4 p-3 bg-white shadow-sm">
          <legend class="float-none w-auto px-3 fs-5 fw-bold text-primary">
            Purchase Items
          </legend>

          <div class="table-responsive">
            <table class="table table-bordered align-middle" id="purchase-item-table">
              <thead class="table-primary text-center">
                <tr>
                  <th>Category</th>
                  <th>Product</th>
                  <th>Batch</th>
                  <th>Quantity</th>
                  <th>Unit Price</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                {{ formset.management_form }}
                {% for form in formset %}
                <tr class="purchase-item-row">
                  <td>{{ form.stationary_category|add_class:"form-select" }}</td>
                  <td>{{ form.stationary_product|add_class:"form-select" }}</td>
                  <td>{{ form.batch|add_class:"form-select" }}</td>
                  <td>{{ form.quantity|add_class:"form-control qty-input text-end" }}</td>
                  <td>{{ form.unit_price|add_class:"form-control price-input text-end" }}</td>
                  <td class="text-center">
                    <button type="button" class="btn btn-danger btn-sm remove-item">
                      <i class="fas fa-trash"></i>
                    </button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>

            <!-- Live total display -->
            <div class="mt-3 text-end">
              <h5><strong>Total Amount:</strong> <span id="totalAmount">0.00</span></h5>
            </div>
          </div>

          <button type="button" class="btn btn-outline-primary btn-sm mt-2" id="add-item">
            <i class="fas fa-plus-circle"></i> Add Item
          </button>
        </fieldset>

        <div class="text-end mt-4">
          <button type="submit" class="btn btn-success px-4">
            <i class="fas fa-save me-2"></i>Save Purchase Order
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- =================== JS SECTION =================== -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    const tableBody = document.querySelector('#purchase-item-table tbody');
    const totalAmountEl = document.getElementById('totalAmount');
    const totalFormsInput = document.querySelector('[id$="TOTAL_FORMS"]');
    let totalForms = parseInt(totalFormsInput.value);

    // Calculate live total
    function calculateTotal() {
        let total = 0;
        document.querySelectorAll('.purchase-item-row').forEach(row => {
            const qty = parseFloat(row.querySelector('.qty-input')?.value || 0);
            const price = parseFloat(row.querySelector('.price-input')?.value || 0);
            total += qty * price;
        });
        totalAmountEl.textContent = total.toFixed(2);
    }

    // Add new row
    document.getElementById('add-item').addEventListener('click', function () {
        const firstRow = document.querySelector('.purchase-item-row');
        const newRow = firstRow.cloneNode(true);

        // Reset inputs
        newRow.querySelectorAll('input, select').forEach(input => {
            const name = input.getAttribute('name').replace(/-\d+-/, `-${totalForms}-`);
            const id = 'id_' + name;
            input.setAttribute('name', name);
            input.setAttribute('id', id);
            if (input.tagName === 'INPUT') input.value = '';
        });

        tableBody.appendChild(newRow);
        totalForms++;
        totalFormsInput.value = totalForms;
        calculateTotal();
    });

    // Remove row
    tableBody.addEventListener('click', function (e) {
        if (e.target.closest('.remove-item')) {
            if (document.querySelectorAll('.purchase-item-row').length > 1) {
                e.target.closest('tr').remove();
                totalForms--;
                totalFormsInput.value = totalForms;
                calculateTotal();
            } else {
                alert('At least one item is required.');
            }
        }
    });

    // Recalculate on input
    document.addEventListener('input', function (e) {
        if (e.target.classList.contains('qty-input') || e.target.classList.contains('price-input')) {
            calculateTotal();
        }
    });

    calculateTotal(); // Initial
});
</script>
{% endblock %}
