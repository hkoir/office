{% extends 'base.html' %}
{% load custom_filters %}
{% block content %}

<div class="container-fluid mt-4">
  <div class="card shadow-sm rounded-4">
    <div class="card-header bg-info text-white rounded-top-4 d-flex justify-content-between align-items-center">
      <h4 class="mb-0"><i class="fas fa-file-alt me-2"></i>Stationary Usage Request</h4>
      <a href="{% url 'officemanagement:usage_request_list' %}" class="btn btn-light btn-sm">Back to List</a>
    </div>

    <div class="card-body bg-light">
      <form method="POST" novalidate>
        {% csrf_token %}
        <div class="row mb-3">
        <div class="col-md-4">
            <label class="form-label fw-semibold">User Name:</label>
            {{ user}}
          </div>

          <div class="col-md-4">
            <label class="form-label fw-semibold">Position:</label>
            {{ request.user.user_position}}
          </div>
          <div class="col-md-4">
            <label class="form-label fw-semibold">Department</label>
            {{ order_form.department|add_class:"form-select" }}
          </div>
          
        </div>

        <fieldset class="border rounded-4 p-3 bg-white shadow-sm">
          <legend class="float-none w-auto px-3 fs-5 fw-bold text-info">Usage Items</legend>

          <div class="table-responsive">
            <table class="table table-bordered align-middle" id="usage-item-table">
              <thead class="table-info text-center">
                <tr>
                  <th>Category</th>
                  <th>Product</th>
                  <th>Batch</th>
                  <th>Quantity</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                {{ formset.management_form }}
                {% for form in formset %}
                <tr class="usage-item-row">
                  <td>{{ form.stationary_category|add_class:"form-select" }}</td>
                  <td>{{ form.stationary_product|add_class:"form-select" }}</td>
                  <td>{{ form.batch|add_class:"form-select" }}</td>
                  <td>{{ form.quantity|add_class:"form-control text-center" }}</td>
                  <td class="text-center">
                    <button type="button" class="btn btn-danger btn-sm remove-item"><i class="fas fa-trash"></i></button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <button type="button" class="btn btn-outline-info btn-sm mt-2" id="add-item">
            <i class="fas fa-plus-circle"></i> Add Item
          </button>
        </fieldset>

        <div class="text-end mt-4">
          <button type="submit" class="btn btn-success px-4"><i class="fas fa-save me-2"></i>Submit Request</button>
        </div>
      </form>
    </div>
  </div>
</div>


<script>
$(document).ready(function () {
    let totalForms = parseInt($('#id_usage_order-TOTAL_FORMS').val());

    // Add new row
    $('#add-item').click(function () {
        const newRow = $('.usage-item-row:first').clone(true);
        newRow.find('input, select').each(function () {
            const name = $(this).attr('name').replace(/-\d+-/, `-${totalForms}-`);
            const id = 'id_' + name;
            $(this).attr({ name: name, id: id }).val('');
        });
        newRow.appendTo('#usage-item-table tbody');
        totalForms++;
        $('#id_usage_order-TOTAL_FORMS').val(totalForms);
    });

    // Remove row
    $('#usage-item-table').on('click', '.remove-item', function () {
        const rowCount = $('.usage-item-row').length;
        if (rowCount > 1) {
            $(this).closest('tr').remove();
            totalForms--;
            $('#id_usage_order-TOTAL_FORMS').val(totalForms);
        } else {
            alert('At least one item is required.');
        }
    });
});
</script>
{% endblock %}
