{% extends 'partner_portal_base.html' %}
{% load custom_filters %}
{% block content %}

<div class="container-fluid">

    <div class="row">
        
        <h2 class="text-center">Create RFQ for Purchase request order: {{ purchase_request_order }}</h2>

        <form method="post">
            {% csrf_token %}

            <!-- RFQ Main Form -->
            <fieldset class="border p-3 mb-4">
                <legend class="w-auto px-2"><strong>RFQ Info</strong></legend>
                <div class="row g-3">
                    <div class=" col-6 col-md-4">
                        <label class="form-label">Purchase Request</label>
                        {{ form.purchase_request_order|add_class:"form-select" }}
                    </div>
                    
                    <div class=" col-6 col-md-4">
                        <label class="form-label">Date</label>
                        {{ form.date|add_class:"form-control" }}
                    </div>
                    <div class=" col-6 col-md-4">
                        <label class="form-label">Valid Until</label>
                        {{ form.valid_until|add_class:"form-control" }}
                    </div>
                    <div class=" col-6 col-md-4">
                        <label class="form-label">Status</label>
                        {{ form.status|add_class:"form-select" }}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Notes</label>
                        {{ form.notes|add_class:"form-control" }}
                    </div>
                </div>
            </fieldset>

            <!-- RFQ Items -->
            <fieldset class="border p-3 mb-4">
                <legend class="w-auto px-2">RFQ Items</legend>
                {{ formset.management_form }}
                <table id="rfq-table" class="table table-bordered table-striped">
                    <thead class="table-dark">
                        <tr>
                            {% for field in formset.empty_form.visible_fields %}
                                {% if field.name != 'DELETE' %}
                                    <th>{{ field.label }}</th>
                                {% endif %}
                            {% endfor %}
                            <th>Delete?</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for form in formset %}
                        <tr>
                            {% for field in form.visible_fields %}
                                {% if field.name != 'DELETE' %}
                                    <td>{{ field|add_class:"form-control" }}</td>
                                {% endif %}
                            {% endfor %}
                            <td>
                                <button type="button" class="btn btn-danger btn-sm delete-row">Delete</button>
                                {{ form.DELETE }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

                <table style="display: none;">
                    <tbody id="empty-form-row">
                        <tr>
                            {% for field in formset.empty_form.visible_fields %}
                                {% if field.name != 'DELETE' %}
                                    <td>{{ field|add_class:"form-control" }}</td>
                                {% endif %}
                            {% endfor %}
                            <td>
                                <button type="button" class="btn btn-danger btn-sm delete-row">Delete</button>
                                {{ formset.empty_form.DELETE }}
                            </td>
                        </tr>
                    </tbody>
                </table>

                <button type="button" id="add-item" class="btn btn-primary mt-2">+ Add Item</button>
                <button type="submit" class="btn btn-success">Save RFQ</button>
            </fieldset>

        
        </form>
   </div>
</div>

<script>
    // Add new item
    const addItemBtn = document.getElementById('add-item');
    const totalForms = document.getElementById('id_{{ formset.prefix }}-TOTAL_FORMS');
    const tableBody = document.querySelector('#rfq-table tbody');
    const emptyFormRow = document.getElementById('empty-form-row').innerHTML;

    addItemBtn.addEventListener('click', () => {
        let formCount = parseInt(totalForms.value);
        let newRow = emptyFormRow.replace(/__prefix__/g, formCount);
        tableBody.insertAdjacentHTML('beforeend', newRow);
        totalForms.value = formCount + 1;
    });

    // Delete row instantly
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('delete-row')) {
            const row = e.target.closest('tr');
            const checkbox = row.querySelector('input[type=checkbox][name$="-DELETE"]');
            if (checkbox) checkbox.checked = true;
            row.style.display = 'none';
        }
    });
</script>
{% endblock %}
