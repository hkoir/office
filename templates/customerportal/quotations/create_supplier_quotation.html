{% extends 'partner_portal_base.html' %}

{% load static %}
{% load custom_filters %}
{% block content %}


<style>
.table td input.form-control,
.table td select.form-control,
.table td textarea.form-control {
  width: 100%;
  min-width: 120px;   /* prevents cells from collapsing too small */
  max-width: 250px;   /* keeps them from overflowing */
  box-sizing: border-box;
}

.table th, .table td {
  vertical-align: middle;
  text-align: center;
  white-space: nowrap;
}

.table-responsive {
  overflow-x: auto;
}
</style>



<div class="container-fluid">

    <div class="row">
        <h2>Create Supplier Quotation</h2>

        <form method="post">
            {% csrf_token %}

            <!-- Quotation Main Form (Professional Layout) -->
            <fieldset class="border p-3 mb-4">
                <legend class="w-auto px-2"><strong>Quotation Info</strong></legend>
                <div class="row g-3">

                    <div class="col-6 col-md-3">
                        <label for="{{ form.supplier.id_for_label }}" class="form-label">Supplier</label>
                        {{ form.supplier|add_class:"form-select" }}
                    </div>
                

                    <div class="col-6 col-md-3">
                        <label for="{{ form.date.id_for_label }}" class="form-label">Date</label>
                        {{ form.date|add_class:"form-control" }}
                    </div>
                                       

                    <div class="col-6 col-md-3">
                        <label for="{{ form.date.id_for_label }}" class="form-label">AIT rate</label>
                        {{ form.AIT_rate|add_class:"form-control" }}
                    </div>
                    
                    <div class="col-6 col-md-3">
                        <label for="{{ form.date.id_for_label }}" class="form-label">AIT Type</label>
                        {{ form.AIT_type|add_class:"form-control" }}
                    </div>

                      <div class="col-6 col-md-3">
                        <label for="{{ form.currency.id_for_label }}" class="form-label">Currency</label>
                        {{ form.currency|add_class:"form-control" }}
                    </div>


                   
                     <div class="col-6 col-md-3">
                        <label for="{{ form.valid_until.id_for_label }}" class="form-label">Valid Until</label>
                        {{ form.valid_until|add_class:"form-control" }}
                    </div>

                    <div class="col-6 col-md-3">
                        <label for="{{ form.status.id_for_label }}" class="form-label">Status</label>
                        {{ form.status|add_class:"form-select" }}
                    </div>

                    <div class="col-6 col-md-auto">
                        <label for="{{ form.notes.id_for_label }}" class="form-label">Notes</label>
                        {{ form.notes|add_class:"form-control" }}
                    </div>
			       <div class="col-6 col-md-auto">
                        <label for="{{ form.quoted_delivery_date.id_for_label }}" class="form-label">Quoted Project delivery Date</label>
                        {{ form.quoted_delivery_date|add_class:"form-control" }}
                    </div>

                </div>
            </fieldset>

            <!-- Quotation Items -->
            <fieldset class="border p-3 mb-4">
                {{ formset.management_form }}
		<div class="table-responsive">
               <legend class="w-auto px-2">Quotation Items</legend>
                <table id="quotation-table" class="table table-bordered table-striped">
                    <thead class="table-dark">
                        <tr>
                            {% for field in formset.empty_form.visible_fields %}
                                {% if field.name != 'DELETE' %}
                                    <th>{{ field.label }}</th>
                                {% endif %}
                            {% endfor %}
                            <th>Delete?</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for form in formset %}
                        <tr>
                            {% for field in form.visible_fields %}
                                {% if field.name != 'DELETE' %}
                                    <td>{{ field|add_class:"form-control" }}</td>
                                {% endif %}
                            {% endfor %}
                            <td>
                                <button type="button" class="btn btn-danger btn-sm delete-row">Delete</button>
                                {{ form.DELETE }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
		</div>

                <!-- Hidden empty row for cloning -->
		<div class="table-rsponsive">
                <table style="display: none;">
                    <tbody id="empty-form-row">
                        <tr>
                            {% for field in formset.empty_form.visible_fields %}
                                {% if field.name != 'DELETE' %}
                                    <td>{{ field|add_class:"form-control" }}</td>
                                {% endif %}
                            {% endfor %}
                            <td>
                                <button type="button" class="btn btn-danger btn-sm delete-row">Delete</button>
                                {{ formset.empty_form.DELETE }}
                            </td>
                        </tr>
                    </tbody>
                </table>
		</div>

                <button type="button" id="add-item" class="btn btn-primary mt-2">+ Add Item</button>
                <button type="submit" class="btn btn-success">Save Quotation</button>
            </fieldset>
        
        </form>

    </div>
</div>

<!-- JS -->
<script>
    // Add new item row
    const addItemBtn = document.getElementById('add-item');
    const totalForms = document.getElementById('id_{{ formset.prefix }}-TOTAL_FORMS');
    const tableBody = document.querySelector('#quotation-table tbody');
    const emptyFormRow = document.getElementById('empty-form-row').innerHTML;

    addItemBtn.addEventListener('click', () => {
        let formCount = parseInt(totalForms.value);
        let newRow = emptyFormRow.replace(/__prefix__/g, formCount);
        tableBody.insertAdjacentHTML('beforeend', newRow);
        totalForms.value = formCount + 1;
    });

    // Delete row instantly
    document.addEventListener('click', function (e) {
        if (e.target.classList.contains('delete-row')) {
            const row = e.target.closest('tr');
            const checkbox = row.querySelector('input[type=checkbox][name$="-DELETE"]');
            if (checkbox) checkbox.checked = true;
            row.style.display = 'none';
        }
    });
</script>
{% endblock %}
