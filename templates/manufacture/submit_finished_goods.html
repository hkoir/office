{% extends 'base.html' %}
{% load custom_filters %}
{% block content %}

{% include 'manufacture/quick_access_button.html' %}

<div class="container-fluid">
   
<h5 class="text-center">Create batch if not availaable.
 <a href="{% url 'purchase:create_batch' %}?next={{ request.path }}" 
            class="btn btn-sm btn-outline-success">
            + Create New Batch
        </a>
</h5>
 <h2 class="text-center mb-4">Submit Finished Goods for Order: {{ materials_request_order }}</h2>

    <form method="post">
        {% csrf_token %}
        {{ formset.management_form }}

        <div class="table-responsive">
            <table class="table table-bordered table-striped">
                <thead class="table-dark">
                    <tr>
                        {% for field in formset.empty_form.visible_fields %}
                            {% if field.name != 'DELETE' %}
                                <th>{{ field.label }}</th>
                            {% endif %}
                        {% endfor %}
                        <th>Delete?</th>
                    </tr>
                </thead>
                <tbody>
                    {% for form in formset %}
                    <tr>
                        {% for field in form.visible_fields %}
                            {% if field.name != 'DELETE' %}
                                <td>{{ field|add_class:"form-control" }}</td>
                            {% endif %}
                        {% endfor %}
                        <td>
                            <button type="button" class="btn btn-danger btn-sm delete-row">Delete</button>
                            {{ form.DELETE }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <!-- Hidden empty row template -->
            <table style="display: none;">
                <tbody id="empty-form-row">
                    <tr>
                        {% for field in formset.empty_form.visible_fields %}
                            {% if field.name != 'DELETE' %}
                                <td>{{ field|add_class:"form-control" }}</td>
                            {% endif %}
                        {% endfor %}
                        <td>
                            <button type="button" class="btn btn-danger btn-sm delete-row">Delete</button>
                            {{ formset.empty_form.DELETE }}
                        </td>
                    </tr>
                </tbody>
            </table>

            <button type="button" id="add-item" class="btn btn-primary mt-2">+ Add Item</button>
            <button type="submit" class="btn btn-success mt-2">Submit Finished Goods</button>
        </div>
    </form>
</div>

<script>
    const addItemBtn = document.getElementById('add-item');
    const totalForms = document.getElementById('id_{{ formset.prefix }}-TOTAL_FORMS');
    const tableBody = document.querySelector('table tbody');
    const emptyFormRow = document.getElementById('empty-form-row').innerHTML;

    addItemBtn.addEventListener('click', () => {
        let formCount = parseInt(totalForms.value);
        let newRow = emptyFormRow.replace(/__prefix__/g, formCount);
        tableBody.insertAdjacentHTML('beforeend', newRow);
        totalForms.value = formCount + 1;
    });

    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('delete-row')) {
            const row = e.target.closest('tr');
            const checkbox = row.querySelector('input[type=checkbox][name$="-DELETE"]');
            if (checkbox) checkbox.checked = true;
            row.style.display = 'none';
        }
    });
</script>

{% endblock %}
